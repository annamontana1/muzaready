generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AdminUser {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      String   @default("editor")
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_users")
}

model Product {
  id                       String     @id @default(cuid())
  name                     String
  category                 String?
  tier                     String
  base_price_per_100g_45cm Float
  set_id                   String?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt
  cartItems                CartItem[]
  favorites                Favorite[]
  variants                 Variant[]

  @@map("products")
}

model Variant {
  id        String   @id @default(cuid())
  productId String
  name      String
  price     Float
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("variants")
}

model Order {
  id String @id @default(cuid())

  // Customer info
  email       String
  firstName   String
  lastName    String
  phone       String?
  companyName String? // for invoicing
  ico         String? // IČO - Company ID
  dic         String? // DIČ - Tax ID

  // Delivery address
  streetAddress String
  city          String
  zipCode       String
  country       String @default("CZ")

  // Billing address (if different from delivery)
  billingStreet  String?
  billingCity    String?
  billingZipCode String?
  billingCountry String?

  // Delivery
  deliveryMethod String @default("standard") // standard, express, pickup, zasilkovna

  // Zásilkovna pick-up point data (JSON)
  packetaPointId   String? // ID výdejního místa
  packetaPointName String? // Název výdejního místa
  packetaPointData String? // JSON s kompletními daty (address, city, zip, country, etc.)

  // Payment & Status
  orderStatus    String  @default("pending") // draft, pending, paid, processing, shipped, completed, cancelled
  paymentStatus  String  @default("unpaid") // unpaid, partial, paid, refunded
  deliveryStatus String  @default("pending") // pending, shipped, delivered, returned
  paymentMethod  String? // gopay, bank_transfer, cash

  // Channel & metadata
  channel   String  @default("web") // web, pos, ig_dm
  tags      String? // JSON string of tags for filtering/organization
  riskScore Int     @default(0) // fraud detection score

  // Notes
  notesInternal String? // internal admin notes
  notesCustomer String? // customer-facing notes

  // Order details
  subtotal       Float
  shippingCost   Float @default(0)
  discountAmount Float @default(0)
  total          Float

  // Coupon/Discount
  couponId   String? // ID použitého kupónu
  couponCode String? // Snapshot kódu pro historii
  coupon     Coupon? @relation(fields: [couponId], references: [id])

  // Tracking
  trackingNumber String?
  carrier        String? // zasilkovna, gls, dpd, ceska_posta, fedex, ups, other

  // Timestamps
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  paidAt             DateTime?
  shippedAt          DateTime?
  lastStatusChangeAt DateTime  @default(now())

  items   OrderItem[]
  invoice Invoice?
  history OrderHistory[]
  reviews Review[]

  @@map("orders")
}

model OrderItem {
  id               String       @id @default(cuid())
  orderId          String
  assemblyFeeCzk   Int?
  assemblyFeeTotal Int?
  assemblyFeeType  String?
  createdAt        DateTime     @default(now())
  ending           EndingOption @default(NONE)
  grams            Int
  lineTotal        Int
  nameSnapshot     String?
  pricePerGram     Int
  saleMode         SaleMode
  skuId            String
  order            Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sku              Sku          @relation(fields: [skuId], references: [id])

  @@map("order_items")
}

model CartItem {
  id        String   @id @default(cuid())
  sessionId String
  productId String
  quantity  Int
  variant   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([sessionId, productId])
  @@map("cart_items")
}

model Favorite {
  id        String   @id @default(cuid())
  sessionId String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([sessionId, productId])
  @@map("favorites")
}

model Sku {
  id               String            @id @default(cuid())
  sku              String            @unique
  name             String?
  productId        String?
  shade            String?
  shadeName        String?
  shadeHex         String?
  shadeRangeStart  Int?
  shadeRangeEnd    Int?
  lengthCm         Int?
  structure        String?
  ending           String?
  ribbonColor      String?
  saleMode         SaleMode
  pricePerGramCzk  Float?
  pricePerGramEur  Float?
  weightTotalG     Int?
  weightGrams      Int?
  priceCzkTotal    Float?
  priceEurTotal    Float?
  soldOut          Boolean           @default(false)
  availableGrams   Int?
  minOrderG        Int?
  stepG            Int?
  inStock          Boolean           @default(false)
  inStockSince     DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  customerCategory CustomerCategory?
  isListed         Boolean           @default(false)
  listingPriority  Int?
  reservedUntil    DateTime?
  orderItems       OrderItem[]
  movements        StockMovement[]
  scanItems        ScanItem[]
  reviews          Review[]
  stockTakeItems   StockTakeItem[]

  @@map("skus")
}

model StockMovement {
  id         String   @id @default(cuid())
  skuId      String
  type       MoveType
  grams      Int
  note       String?
  refOrderId String?

  // Enhanced tracking
  performedBy String?  // Admin user who performed the action
  location    String?  // Warehouse location (e.g., "A1-3", "Shelf B2")
  batchNumber String?  // Lot/Batch tracking for traceability
  reason      String?  // Reason for adjustment (damage, theft, correction, etc.)

  // Cost tracking
  costPerGramCzk Float?  // Purchase cost for IN movements

  // Sale tracking (for IN movements that get sold)
  soldAt DateTime? // When this item was sold
  soldBy String?   // Who sold it (admin user)

  createdAt  DateTime @default(now())
  sku        Sku      @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@index([skuId])
  @@index([type])
  @@index([createdAt])
  @@index([batchNumber])
  @@map("stock_movements")
}

model PriceMatrix {
  id              String   @id @default(cuid())
  category        String
  tier            String
  shadeRangeStart Int?
  shadeRangeEnd   Int?
  lengthCm        Int
  pricePerGramCzk Float
  pricePerGramEur Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([category, tier, shadeRangeStart, shadeRangeEnd, lengthCm])
  @@index([category, tier])
  @@map("price_matrix")
}

enum HairTreatment {
  PANENSKE_NEBARVENE
  BARVENE
}

enum CustomerCategory {
  STANDARD
  LUXE
  PLATINUM_EDITION
}

enum SaleMode {
  PIECE_BY_WEIGHT
  BULK_G
}

enum EndingOption {
  KERATIN
  PASKY
  TRESSY
  NONE
}

enum MoveType {
  IN          // Naskladnění (příjem zboží)
  OUT         // Vyskladnění (prodej, výdej)
  ADJUST      // Inventurní úprava
  TRANSFER    // Přesun mezi lokacemi
  DAMAGE      // Poškození/znehodnocení
  RETURN      // Vrácení zboží od zákazníka
}

// Inventory/Stock Take management
model StockTake {
  id          String   @id @default(cuid())
  name        String   // e.g., "Měsíční inventura 12/2024"
  status      StockTakeStatus @default(PLANNED)

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  performedBy String?  // Admin user
  notes       String?

  items StockTakeItem[]

  @@map("stock_takes")
}

model StockTakeItem {
  id String @id @default(cuid())

  stockTakeId String
  stockTake   StockTake @relation(fields: [stockTakeId], references: [id], onDelete: Cascade)

  skuId String
  sku   Sku    @relation(fields: [skuId], references: [id])

  // System vs Physical count
  expectedGrams Int  // What system says
  countedGrams  Int  // What was physically counted
  difference    Int  // countedGrams - expectedGrams

  location String?  // Where it was counted
  notes    String?

  createdAt DateTime @default(now())

  @@index([stockTakeId])
  @@index([skuId])
  @@map("stock_take_items")
}

enum StockTakeStatus {
  PLANNED     // Naplánováno
  IN_PROGRESS // Probíhá
  COMPLETED   // Dokončeno
  CANCELLED   // Zrušeno
}

model ExchangeRate {
  id          String   @id @default(cuid())
  czk_to_eur  Decimal
  description String?
  lastUpdated DateTime @default(now())
  updatedBy   String?

  @@map("exchange_rates")
}

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  password  String
  firstName String
  lastName  String
  phone     String?

  // Wholesale specific
  wholesaleRequested   Boolean   @default(false)
  isWholesale          Boolean   @default(false)
  wholesaleRequestedAt DateTime?
  wholesaleApprovedAt  DateTime?

  // Business info (for wholesale users)
  companyName   String?
  businessType  String? // "salon", "stylist", "distributor"
  website       String?
  instagram     String?
  country       String?
  city          String?
  zipCode       String?
  streetAddress String?
  taxId         String?

  // Status
  status    String   @default("active") // active, suspended, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions Session[]
  reviews  Review[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("sessions")
}

model ScanSession {
  id          String     @id @default(cuid())
  status      String     @default("active") // active, scanning, paused, completed, synced
  scannedBy   String? // admin user who is scanning
  startedAt   DateTime   @default(now())
  completedAt DateTime?
  totalPrice  Int        @default(0) // total price in CZK cents
  itemCount   Int        @default(0) // total number of items
  syncedAt    DateTime? // when session was synced to order
  items       ScanItem[]

  @@map("scan_sessions")
}

model ScanItem {
  id        String      @id @default(cuid())
  sessionId String
  skuId     String
  skuName   String // snapshot of SKU name
  price     Int // price per unit in CZK cents
  quantity  Int // quantity of items
  scannedAt DateTime    @default(now())
  status    String      @default("pending") // pending, verified, error
  notes     String?
  session   ScanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sku       Sku         @relation(fields: [skuId], references: [id])

  @@map("scan_items")
}

model Invoice {
  id String @id @default(cuid())

  // Invoice number (auto-generated: 2025001, 2025002, etc.)
  invoiceNumber String @unique

  // Related order
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  // Supplier info (your company - Mùza Hair)
  supplierName    String  @default("Mùza Hair s.r.o.")
  supplierStreet  String? // will be filled by you
  supplierCity    String? // will be filled by you
  supplierZipCode String? // will be filled by you
  supplierCountry String  @default("CZ")
  supplierIco     String? // Your IČO - will be filled by you
  supplierDic     String? // Your DIČ - will be filled by you
  supplierEmail   String? // info@muzahair.cz
  supplierPhone   String? // +420 728 722 880

  // Customer info (copied from order)
  customerName    String // firstName + lastName or companyName
  customerEmail   String
  customerPhone   String?
  customerStreet  String
  customerCity    String
  customerZipCode String
  customerCountry String
  customerIco     String? // if company
  customerDic     String? // if company

  // Invoice amounts
  subtotal  Float // without VAT
  vatRate   Float @default(21.0) // VAT 21%
  vatAmount Float // calculated: subtotal * (vatRate/100)
  total     Float // subtotal + vatAmount

  // Payment info
  paymentMethod  String? // GoPay, bank transfer, cash
  variableSymbol String? // for bank transfers
  bankAccount    String? // Your bank account - will be filled by you
  iban           String? // Your IBAN - will be filled by you
  swift          String? // Your SWIFT - will be filled by you

  // Invoice dates
  issueDate DateTime  @default(now()) // datum vystavení
  dueDate   DateTime? // datum splatnosti
  taxDate   DateTime? // datum zdanitelného plnění
  paidDate  DateTime? // datum zaplacení

  // Status
  status String @default("draft") // draft, issued, paid, cancelled, credited

  // PDF storage
  pdfUrl       String? // URL to generated PDF (Vercel Blob or Supabase Storage)
  pdfGenerated Boolean @default(false)

  // Notes
  note String? // Additional note on invoice

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoices")
}

model OrderHistory {
  id         String   @id @default(cuid())
  orderId    String
  changedBy  String? // Admin email or system
  field      String // Field name that changed (e.g., "orderStatus", "paymentStatus", "email")
  oldValue   String? // Old value (JSON string for complex values)
  newValue   String? // New value (JSON string for complex values)
  changeType String // "status_change", "field_update", "note_added", "stock_deduction", "stock_return"
  note       String? // Additional note about the change
  createdAt  DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_history")
}

model Coupon {
  id          String   @id @default(cuid())
  code        String   @unique // Unikátní kód kupónu (např. "LETO2025")
  description String? // Popis kupónu pro adminy

  // Discount settings
  discountType   String  // "percentage" nebo "fixed_amount"
  discountValue  Float   // 10 pro 10%, nebo 500 pro 500 Kč
  minOrderAmount Float?  // Minimální částka objednávky (volitelné)
  maxDiscount    Float?  // Max sleva v Kč (pro percentage kupóny)

  // Usage limits
  maxUses       Int?     // Celkový počet použití (null = neomezené)
  usedCount     Int      @default(0) // Kolikrát již použito
  maxUsesPerUser Int?    @default(1) // Max použití na zákazníka

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime? // null = neomezená platnost

  // Status
  isActive Boolean @default(true)

  // Applicability rules (JSON)
  rules String? // JSON: { "minItems": 2, "productIds": ["id1"], "categories": ["cat1"] }

  // Metadata
  createdBy String? // Admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders Order[]

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("coupons")
}

enum CouponDiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model Review {
  id String @id @default(cuid())

  // What is being reviewed
  skuId String
  sku   Sku    @relation(fields: [skuId], references: [id], onDelete: Cascade)

  // Who wrote the review
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Review can be from verified purchase
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Review data
  rating  Int // 1-5 stars
  title   String? // Optional short title
  comment String // Review text

  // Customer info (for non-logged users or display)
  customerName  String
  customerEmail String?

  // Admin moderation
  isApproved Boolean  @default(false)
  isVerified Boolean  @default(false) // True if from verified purchase
  adminNotes String?

  // Helpful votes
  helpfulCount Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([skuId])
  @@index([userId])
  @@index([isApproved])
  @@index([rating])
  @@map("reviews")
}

// ============================================
// SEO & Content Management Models
// ============================================

model PageSeo {
  id             String   @id @default(cuid())
  slug           String   @unique // URL cesta: "/", "/o-nas", "/vlasy-k-prodlouzeni"
  pageName       String?  // Lidsky čitelný název stránky pro admin

  // Meta tagy
  titleCs        String?
  titleEn        String?
  descriptionCs  String?  @db.Text
  descriptionEn  String?  @db.Text
  keywordsCs     String?  // comma-separated
  keywordsEn     String?

  // OpenGraph
  ogImageUrl     String?
  ogType         String   @default("website")

  // Strukturovaná data (JSON-LD)
  structuredData String?  @db.Text // JSON string

  // Canonical & Robots
  canonicalUrl   String?
  noIndex        Boolean  @default(false)
  noFollow       Boolean  @default(false)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  updatedBy      String?

  @@map("page_seo")
}

model PageContent {
  id          String   @id @default(cuid())
  slug        String   @unique // URL cesta nebo identifikátor sekce
  pageName    String?  // Lidsky čitelný název
  pageType    String   // "static", "category", "homepage_section", "faq"
  sectionKey  String?  // pro homepage sekce: "hero", "usp", "collections"

  // Obsah (Markdown)
  contentCs   String?  @db.Text
  contentEn   String?  @db.Text

  // Metadata
  isPublished Boolean  @default(true)
  sortOrder   Int      @default(0)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([pageType])
  @@index([isPublished])
  @@map("page_content")
}

model Redirect {
  id         String   @id @default(cuid())
  fromPath   String   @unique
  toPath     String
  statusCode Int      @default(301) // 301 nebo 302
  isActive   Boolean  @default(true)
  note       String?  // Poznámka proč redirect existuje

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([isActive])
  @@map("redirects")
}

model FaqItem {
  id          String   @id @default(cuid())
  category    String   // "O produktech", "Doprava", "Platba" atd.
  questionCs  String
  questionEn  String?
  answerCs    String   @db.Text // Markdown
  answerEn    String?  @db.Text
  sortOrder   Int      @default(0)
  isPublished Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isPublished])
  @@map("faq_items")
}
